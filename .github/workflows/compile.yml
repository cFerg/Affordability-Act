name: Compile master bill

on:
  push:
    branches: ["**"]
    paths:
      - "policy/sections/**"
      - "tools/compile_master.py"
      - "tools/update_index.py"
      - ".github/workflows/compile.yml"
      - "policy/README.md"
  pull_request:
    branches: ["**"]
    paths:
      - "policy/sections/**"
      - "tools/compile_master.py"
      - "tools/update_index.py"
      - "policy/README.md"

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: compile-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Detect changed section files
        id: changed
        uses: tj-actions/changed-files@v44
        with:
          files: |
            policy/sections/**/README.md

      - name: Compile
        run: python3 tools/compile_master.py

      - name: Update policy README index
        run: python3 tools/update_index.py

      - name: Can commit?
        id: can
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "can=true" >> "$GITHUB_OUTPUT"
          elif [ "${{ github.event_name }}" = "pull_request" ] && [ "${{ github.event.pull_request.head.repo.full_name }}" = "${{ github.repository }}" ]; then
            echo "can=true" >> "$GITHUB_OUTPUT"
          else
            echo "can=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Resolve commit identity
        id: ident
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            ACT="${{ github.event.pull_request.user.login }}"
            ID="${{ github.event.pull_request.user.id }}"
            PRNUM="${{ github.event.pull_request.number }}"
          else
            ACT="${{ github.actor }}"
            ID="${{ github.event.sender.id }}"
            PRNUM=""
          fi
          [ -z "$ACT" ] && ACT="${{ github.actor }}"
          [ -z "$ID" ] && ID="41898282"  # fallback to actions bot id
          echo "name=$ACT" >> "$GITHUB_OUTPUT"
          echo "email=${ID}+${ACT}@users.noreply.github.com" >> "$GITHUB_OUTPUT"
          echo "prnum=$PRNUM" >> "$GITHUB_OUTPUT"

      - name: Build commit title
        id: msg
        shell: bash
        env:
          CHANGED: ${{ steps.changed.outputs.all_changed_files }}
          ACTOR: ${{ steps.ident.outputs.name }}
          PRNUM: ${{ steps.ident.outputs.prnum }}
        run: |
          secs=$(echo "$CHANGED" | tr ' ' '\n' | sed -n 's#^policy/sections/\([^/]*\)/README.md#\1#p' | tr '\n' ',' | sed 's/,$//')
          title="docs(policy): rebuild master bill & update index"
          [ -n "$PRNUM" ] && title="$title (#$PRNUM)"
          [ -n "$ACTOR" ] && title="$title by @$ACTOR"
          [ -n "$secs" ] && title="$title ‚Äî $secs"
          title="$title [skip ci]"
          echo "title=$title" >> "$GITHUB_OUTPUT"

      - name: Commit compiled bill + index (if changed)
        id: autocommit
        if: steps.can.outputs.can == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: ${{ steps.msg.outputs.title }}
          file_pattern: |
            policy/bill-text.md
            policy/README.md
          commit_user_name: ${{ steps.ident.outputs.name }}
          commit_user_email: ${{ steps.ident.outputs.email }}

      - name: Upload compiled bill (artifact)
        if: steps.can.outputs.can != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: bill-text.md
          path: policy/bill-text.md

      - name: Comment on PR (commit pushed)
        if: github.event_name == 'pull_request' && steps.can.outputs.can == 'true' && steps.autocommit.outputs.changes_detected == 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ‚úÖ **Master bill recompiled** and **index updated**.
            - Author: @${{ steps.ident.outputs.name }}
            - Commit: `${{ steps.autocommit.outputs.commit_hash }}`
            - Sections touched: `${{ steps.changed.outputs.all_changed_files }}`
            - Outputs: `policy/bill-text.md`, `policy/README.md`

      - name: Comment on PR (no changes)
        if: github.event_name == 'pull_request' && steps.can.outputs.can == 'true' && steps.autocommit.outputs.changes_detected != 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ‚ÑπÔ∏è **Compile completed** ‚Äî no changes to `policy/bill-text.md` or `policy/README.md`.
            - Author: @${{ steps.ident.outputs.name }}
            - Sections touched: `${{ steps.changed.outputs.all_changed_files }}`

      - name: Comment on PR (artifact uploaded)
        if: github.event_name == 'pull_request' && steps.can.outputs.can != 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            üìé **Compile completed** (forked PR) ‚Äî cannot push.
            - Author: @${{ steps.ident.outputs.name }}
            - Sections touched: `${{ steps.changed.outputs.all_changed_files }}`
            - Download artifact: `bill-text.md`
