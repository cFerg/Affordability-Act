<div class="section-nav" data-current="{{ page.url }}">
  <div class="row">
    <a class="btn sm" id="prevSec" href="#" hidden>← Prev</a>
    <select id="secJump"></select>
    <a class="btn sm" id="nextSec" href="#" hidden>Next →</a>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  const wrap = document.querySelector('.section-nav');
  if (!wrap) return;
  const currentUrl = wrap.getAttribute('data-current') || '';
  const sel = document.getElementById('secJump');
  const prev = document.getElementById('prevSec');
  const next = document.getElementById('nextSec');

  async function getSections() {
    try {
      const res = await fetch('/sections.json', { cache: 'no-store' });
      return await res.json();
    } catch { return []; }
  }

  const list = await getSections();
  if (!Array.isArray(list) || !list.length) return;

  const onBillText = location.pathname.includes('/policy/bill-text');

  function valueFor(item, i) {
    // Prefer in-page anchor when on the compiled bill page
    if (onBillText) {
      const n = item.n || (i+1);
      return `#section-${n}`;
    }
    return item.url;
  }

  // populate dropdown
  sel.innerHTML = list.map((s, i) => {
    const value = valueFor(s, i);
    const selected = (s.url === currentUrl) || (onBillText && location.hash === value);
    return `<option value="${value}" ${selected ? 'selected' : ''}>${s.title}</option>`;
  }).join('');

  // find current index
  let i = Math.max(0, list.findIndex(s => s.url === currentUrl));
  if (onBillText && location.hash.startsWith('#section-')) {
    const n = parseInt(location.hash.replace('#section-',''), 10);
    if (!Number.isNaN(n) && n>=1 && n<=list.length) i = n-1;
  }

  const prevHref = valueFor(list[Math.max(0, i-1)], Math.max(0, i-1));
  const nextHref = valueFor(list[Math.min(list.length-1, i+1)], Math.min(list.length-1, i+1));

  if (i > 0) { prev.hidden = false; prev.href = prevHref; }
  if (i < list.length-1) { next.hidden = false; next.href = nextHref; }

  sel.addEventListener('change', () => {
    const v = sel.value;
    if (v.startsWith('#')) {
      const el = document.querySelector(v);
      if (el) { el.scrollIntoView({ behavior:'smooth', block:'start' }); return; }
    }
    window.location.href = v;
  });
});
</script>